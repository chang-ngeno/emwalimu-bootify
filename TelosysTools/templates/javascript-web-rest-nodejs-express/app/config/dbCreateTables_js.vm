/*
 * Created on $today.date ( Time $today.time )
 * Generated by $generator.name ( version $generator.version )
 */

const sqlite3 = require('sqlite3').verbose();

/**
 * Database tables creation
 */
let db;

/**
 * Init entities tables if they don't exist
 * @param db Database connection
 */
module.exports = function getDatabase(filename) {

  if(!db) {
    // Load database file (Creates file if it does not exists)
    db = new sqlite3.Database(filename);

    // Initialize database : create tables	
#set ( $fkLines = '' )
#foreach ($entity in $selectedEntities)
#set ( $uncapitalizedEntityName = ${fn.uncapitalize($entity.name)})
#set ( $createTable = "CREATE TABLE if not exists $uncapitalizedEntityName (
      " )
#foreach ( $attrib in $entity.attributes)
#set ( $uncapitalizedAttribName = "${fn.uncapitalize($attrib.name)}")
#if ( $foreach.count > 1 )
#set ( $createTable = $createTable + ", 
      " )
#end
#if ( $attrib.type == "String" )
#set ( $createTable = $createTable + $uncapitalizedAttribName + " " + $attrib.databaseType )
#elseif ( $attrib.type == "int" || $attrib.type == "Integer" )
#set ( $createTable = $createTable + $uncapitalizedAttribName + " " + "INTEGER" )
#else
#set ( $createTable = $createTable + $uncapitalizedAttribName + " " + $attrib.type )
##
#end
##
#if ( $entity.keyAttributes.size() > 1 )
#else
#if ( $attrib.isKeyElement() )
#set ( $createTable = $createTable + " PRIMARY KEY" )
#end
#end
##
#if ( $attrib.isAutoIncremented() )
#set ( $createTable = $createTable + " AUTOINCREMENT" )
#end
##
#if ( $attrib.isFK() )
#set ( $fkLines = $fkLines + ", 
      FOREIGN KEY("+ $uncapitalizedAttribName + ") REFERENCES " + $fn.uncapitalize($attrib.referencedEntityName) + "(" + $fn.uncapitalize($attrib.referencedEntity.keyAttribute.name) + ") ON DELETE SET NULL" )
#else
##
#if ( $attrib.isNotNull() )
#set ( $createTable = $createTable + " NOT NULL" )
#end
## End foreach $attrib in $entity.attributes
#end
##
#end
#if ( $entity.keyAttributes.size() > 1 )
#set ( $createTable = $createTable + ", PRIMARY KEY (")
##
#set ( $compositeConfigKeys = "" )
#foreach ( $key in $entity.keyAttributes )
#if ( $foreach.count > 1 )
#set ( $compositeConfigKeys = $compositeConfigKeys + ", " )
#end
#set ( $compositeConfigKeys = $compositeConfigKeys + $key.name )
#end
##
#set ( $createTable = $createTable + $compositeConfigKeys + ")" )
#end
#set ( $createTable = $createTable + $fkLines )
#set ( $createTable = $createTable + "
    )" )
#set ( $fkLines = '' )
    // $entity table
    console.log(`Creating table if it does not exists : '$uncapitalizedEntityName'`);
    db.run(`$createTable`);
#end

	// Enable SQLite foreign key constraints enforcement
    db.run("PRAGMA foreign_keys=ON;");
  }
  return db;
};